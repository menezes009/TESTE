<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ler QR por Imagem (Fallback Duplo)</title>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu; background:#0b0f14; color:#e5e7eb; margin:0; padding:16px; }
    main { max-width: 780px; margin: 0 auto; }
    h1 { margin: 0 0 12px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin: 8px 0; }
    input, button { padding: 10px 12px; border:1px solid #374151; background:#1f2937; color:#e5e7eb; border-radius:10px; }
    .card { background:#0f172a; border:1px solid #1f2937; border-radius:12px; padding:12px; margin:12px 0; }
    #preview { max-width: 420px; display:block; border-radius:10px; }
    .ok { color:#16a34a; } .err{ color:#ef4444; } .warn{ color:#f59e0b; }
    .muted{ opacity:.75; }
  </style>
</head>
<body>
  <main>
    <h1>Ler QR por Imagem – Fallback Duplo</h1>
    <div class="row">
      <input type="file" id="file" accept="image/*" capture="environment" />
      <button id="btnScan">Ler imagem</button>
      <small class="muted">Se falhar, tente tirar <b>foto</b> em JPG/PNG (HEIC pode falhar no iOS).</small>
    </div>
    <div class="card">
      <img id="preview" alt="prévia" />
      <p id="out">Aguardando imagem…</p>
    </div>

    <script>
      const elFile = document.getElementById('file');
      const elBtn = document.getElementById('btnScan');
      const elOut = document.getElementById('out');
      const elPrev = document.getElementById('preview');

      function setOut(text, cls=''){ elOut.className = cls; elOut.textContent = text; }

      async function readWithHtml5Qrcode(file){
        const q = new Html5Qrcode(/* element id not used for scanFile */ 'html5qrcode-placeholder');
        try {
          const txt = await q.scanFile(file, true);
          return txt;
        } finally {
          try { await q.clear(); } catch(e){}
        }
      }

      function readWithJsQR(file){
        return new Promise((resolve, reject) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            canvas.width = img.naturalWidth;
            canvas.height = img.naturalHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const result = jsQR(imageData.data, canvas.width, canvas.height);
            if (result && result.data) resolve(result.data);
            else reject(new Error('jsQR não encontrou QR na imagem.'));
          };
          img.onerror = () => reject(new Error('Falha ao carregar a imagem (talvez HEIC?).'));
          const url = URL.createObjectURL(file);
          img.src = url;
          // mostra prévia
          elPrev.src = url;
        });
      }

      function extractCodigo(text){
        try {
          const u = new URL(text);
          const params = new URLSearchParams(u.search || '');
          const c = params.get('codigo') || params.get('code') || params.get('c');
          if (c) return c.trim();
        } catch {}
        const idx = text.indexOf('codigo=');
        const base = idx >= 0 ? text.slice(idx+7) : text;
        return String(base).split('&')[0].trim();
      }

      elBtn.addEventListener('click', async () => {
        const file = elFile.files && elFile.files[0];
        if (!file) { setOut('Selecione uma imagem primeiro.', 'warn'); return; }
        setOut('Lendo (html5-qrcode)…');
        try {
          const txt = await readWithHtml5Qrcode(file);
          const code = extractCodigo(txt || '');
          setOut('QR lido (html5-qrcode): ' + (code || txt), code ? 'ok':'warn');
          return;
        } catch (e1) {
          setOut('Falhou html5-qrcode, tentando jsQR…', 'warn');
          try {
            const txt2 = await readWithJsQR(file);
            const code2 = extractCodigo(txt2 || '');
            setOut('QR lido (jsQR): ' + (code2 || txt2), code2 ? 'ok':'warn');
            return;
          } catch (e2) {
            setOut('Falha ao ler a imagem. Tente salvar como JPG/PNG ou fazer um print/screenshot do QR. Erro: ' + (e2.message || e2), 'err');
          }
        }
      });
    </script>
  </main>
</body>
</html>
